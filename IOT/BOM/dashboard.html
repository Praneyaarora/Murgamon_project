<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farm BOM Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric { display: flex; justify-content: space-between; margin: 10px 0; }
        .metric-value { font-weight: bold; color: #2c3e50; }
        .status-online { color: #27ae60; }
        .status-offline { color: #e74c3c; }
        .alert-critical { background: #ffebee; border-left: 4px solid #f44336; }
        .alert-warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        .alert-info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .btn { padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #2980b9; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .timestamp { color: #666; font-size: 0.9em; }
        .refresh-btn { float: right; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸšœ Smart Farm BOM Dashboard</h1>
        <p>Real-time monitoring and control system</p>
        <button class="btn refresh-btn" onclick="refreshData()">ðŸ”„ Refresh</button>
    </div>

    <div class="grid">
        <!-- System Status -->
        <div class="card">
            <h3>System Status</h3>
            <div id="system-status">
                <div class="metric">
                    <span>Status:</span>
                    <span id="system-status-value" class="metric-value">Loading...</span>
                </div>
                <div class="metric">
                    <span>Last Update:</span>
                    <span id="last-update" class="metric-value timestamp">-</span>
                </div>
                <div class="metric">
                    <span>Recent BOM Readings:</span>
                    <span id="recent-bom" class="metric-value">-</span>
                </div>
                <div class="metric">
                    <span>Recent Animal Data:</span>
                    <span id="recent-animals" class="metric-value">-</span>
                </div>
                <div class="metric">
                    <span>Unacknowledged Alerts:</span>
                    <span id="unack-alerts" class="metric-value">-</span>
                </div>
            </div>
        </div>

        <!-- Environmental Sensors -->
        <div class="card">
            <h3>Environmental Sensors</h3>
            <div id="environmental-sensors">
                <div class="metric">
                    <span>Temperature:</span>
                    <span id="temperature" class="metric-value">- Â°C</span>
                </div>
                <div class="metric">
                    <span>Humidity:</span>
                    <span id="humidity" class="metric-value">- %</span>
                </div>
                <div class="metric">
                    <span>COâ‚‚:</span>
                    <span id="co2" class="metric-value">- ppm</span>
                </div>
                <div class="metric">
                    <span>NHâ‚ƒ:</span>
                    <span id="nh3" class="metric-value">- ppm</span>
                </div>
                <div class="metric">
                    <span>PM2.5:</span>
                    <span id="pm25" class="metric-value">- Î¼g/mÂ³</span>
                </div>
                <div class="metric">
                    <span>CO:</span>
                    <span id="co" class="metric-value">- ppm</span>
                </div>
            </div>
        </div>

        <!-- Active Devices -->
        <div class="card">
            <h3>Active Devices</h3>
            <div id="active-devices">
                <div class="metric">
                    <span>Ear Tags:</span>
                    <span id="ear-tags-count" class="metric-value">-</span>
                </div>
                <div class="metric">
                    <span>Sprinkler Systems:</span>
                    <span id="sprinkler-count" class="metric-value">-</span>
                </div>
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="card">
            <h3>Recent Alerts</h3>
            <div id="recent-alerts">
                Loading alerts...
            </div>
        </div>

        <!-- Animal Health -->
        <div class="card">
            <h3>Animal Health Summary</h3>
            <div id="animal-health">
                <table>
                    <thead>
                        <tr>
                            <th>Animal ID</th>
                            <th>Heart Rate</th>
                            <th>SpOâ‚‚</th>
                            <th>Temperature</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody id="animal-table-body">
                        <tr><td colspan="5">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;

        async function fetchData(url) {
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString();
        }

        function formatValue(value, unit = '', decimals = 1) {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'number') {
                return value.toFixed(decimals) + unit;
            }
            return value + unit;
        }

        async function updateSystemStatus() {
            const data = await fetchData('/api/status');
            if (!data) return;

            document.getElementById('system-status-value').textContent = data.status;
            document.getElementById('system-status-value').className = 
                'metric-value ' + (data.status === 'online' ? 'status-online' : 'status-offline');

            document.getElementById('last-update').textContent = formatTimestamp(data.timestamp);
            document.getElementById('recent-bom').textContent = data.stats.recent_bom || 0;
            document.getElementById('recent-animals').textContent = data.stats.recent_ear_tags || 0;
            document.getElementById('unack-alerts').textContent = data.stats.unack_alerts || 0;

            // Update environmental sensors
            const sensors = data.latest_sensors;
            document.getElementById('temperature').textContent = formatValue(sensors.temperature, ' Â°C');
            document.getElementById('humidity').textContent = formatValue(sensors.humidity, ' %');
            document.getElementById('co2').textContent = formatValue(sensors.co2, ' ppm', 0);
            document.getElementById('nh3').textContent = formatValue(sensors.nh3, ' ppm');
            document.getElementById('pm25').textContent = formatValue(sensors.pm25, ' Î¼g/mÂ³');
            document.getElementById('co').textContent = formatValue(sensors.co, ' ppm');

            // Update active devices
            const devices = data.active_devices;
            document.getElementById('ear-tags-count').textContent = devices.EAR_TAG || 0;
            document.getElementById('sprinkler-count').textContent = devices.SPRINKLER_SYSTEM || 0;
        }

        async function updateAlerts() {
            const data = await fetchData('/api/alerts');
            if (!data) return;

            const alertsContainer = document.getElementById('recent-alerts');
            if (data.length === 0) {
                alertsContainer.innerHTML = '<p>No recent alerts</p>';
                return;
            }

            const alertsHtml = data.slice(0, 5).map(alert => {
                const severityClass = `alert-${alert.severity.toLowerCase()}`;
                return `
                    <div class="metric ${severityClass}" style="padding: 10px; margin: 5px 0; border-radius: 4px;">
                        <div>
                            <strong>${alert.alert_type}</strong> - ${alert.device_id}<br>
                            <small>${alert.message}</small><br>
                            <span class="timestamp">${formatTimestamp(alert.timestamp)}</span>
                        </div>
                        ${!alert.acknowledged ? 
                            `<button class="btn" onclick="acknowledgeAlert(${alert.id})">Acknowledge</button>` : 
                            '<span style="color: green;">âœ“ Acknowledged</span>'
                        }
                    </div>
                `;
            }).join('');

            alertsContainer.innerHTML = alertsHtml;
        }

        async function updateAnimalHealth() {
            const data = await fetchData('/api/animals');
            if (!data) return;

            const tbody = document.getElementById('animal-table-body');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No animal data available</td></tr>';
                return;
            }

            const rowsHtml = data.map(animal => `
                <tr>
                    <td>${animal.device_id}</td>
                    <td>${formatValue(animal.avg_hr, ' bpm', 0)}</td>
                    <td>${formatValue(animal.avg_spo2, '%')}</td>
                    <td>${formatValue(animal.avg_temp, 'Â°C')}</td>
                    <td class="timestamp">${formatTimestamp(animal.last_seen)}</td>
                </tr>
            `).join('');

            tbody.innerHTML = rowsHtml;
        }

        async function acknowledgeAlert(alertId) {
            try {
                const response = await fetch(`/api/alerts/${alertId}/acknowledge`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    updateAlerts(); // Refresh alerts
                }
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }

        async function refreshData() {
            await Promise.all([
                updateSystemStatus(),
                updateAlerts(),
                updateAnimalHealth()
            ]);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();

            // Set up auto-refresh every 30 seconds
            refreshInterval = setInterval(refreshData, 30000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>